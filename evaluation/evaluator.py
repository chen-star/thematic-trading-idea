import os
import google.generativeai as genai
from dataclasses import dataclass
from typing import Optional

# Configure the Gemini API
# Assumes GOOGLE_API_KEY is set in the environment
if "GOOGLE_API_KEY" in os.environ:
    genai.configure(api_key=os.environ["GOOGLE_API_KEY"])


@dataclass
class EvaluationResult:
    score: int
    reasoning: str
    relevance: str
    completeness: str
    actionability: str


class Evaluator:
    def __init__(self, model_name: str = "gemini-1.5-flash"):
        self.model = genai.GenerativeModel(model_name)

    def evaluate_report(self, topic: str, report_content: str) -> EvaluationResult:
        prompt = f"""
        You are an expert financial analyst evaluator. Your task is to evaluate a trading idea report generated by an AI agent.
        
        The user asked for a report on the thematic topic: "{topic}"
        
        Here is the generated report:
        ---
        {report_content}
        ---
        
        Please evaluate this report based on the following criteria:
        1. **Relevance**: Does the report directly address the requested topic?
        2. **Completeness**: Does it cover technical analysis, fundamental analysis, and sentiment analysis?
        3. **Actionability**: Does it provide a clear conclusion or recommendation (Buy/Sell/Hold/Watch)?
        4. **Coherence**: Is the report well-structured and easy to read?
        
        Provide a score from 1 to 10 (10 being perfect).
        
        Output your evaluation in the following format:
        Score: [1-10]
        Relevance: [Comment]
        Completeness: [Comment]
        Actionability: [Comment]
        Reasoning: [Detailed explanation of the score]
        """

        try:
            response = self.model.generate_content(prompt)
            text = response.text

            # Simple parsing (robustness could be improved)
            score = 0
            relevance = ""
            completeness = ""
            actionability = ""
            reasoning = ""

            for line in text.split("\n"):
                if line.startswith("Score:"):
                    try:
                        score = int(line.split(":")[1].strip())
                    except:
                        pass
                elif line.startswith("Relevance:"):
                    relevance = line.split(":")[1].strip()
                elif line.startswith("Completeness:"):
                    completeness = line.split(":")[1].strip()
                elif line.startswith("Actionability:"):
                    actionability = line.split(":")[1].strip()
                elif line.startswith("Reasoning:"):
                    reasoning = line.split(":")[1].strip()

            # If reasoning is multi-line, it might be missed by simple split.
            # For a basic version, this is okay.

            return EvaluationResult(
                score=score,
                reasoning=reasoning or text,  # Fallback to full text if parsing fails
                relevance=relevance,
                completeness=completeness,
                actionability=actionability,
            )

        except Exception as e:
            return EvaluationResult(
                score=0,
                reasoning=f"Evaluation failed: {e}",
                relevance="N/A",
                completeness="N/A",
                actionability="N/A",
            )
